
local function printUsage()
    print( "Usage:" )
    print( "git get <localFile> <user> <repo> <file> [branch]" )
    print( "  If branch is blank, it will default to master" )
end
 
local tArgs = { ... }
if #tArgs < 4 then
    printUsage()
    return
end
 
if not http then
    printError( "Git requires http API" )
    printError( "Set http_enable to true in ComputerCraft.cfg" )
    return
end

local function uE(string)
    return textutils.urlEncode( string )
end
 
local function get(user, repo, branch, file)
    url = "https://raw.githubusercontent.com/"..user.."/"..repo.."/"..branch.."/"..file
    write("Connecting to "..url.."... ")
    local response = http.get(url)
    if response then
        print( "Success." )
        local sResponse = response.readAll()
        response.close()
        if sResponse ~= "404: Not Found" then
            return sResponse
        else
            printError("File not found.");
        end
    else
        printError( "Failed." )
    end
end
 
local sCommand = tArgs[1]
 
if sCommand == "get" then
    if #tArgs < 5 then
        printUsage()
        return
    end
 
    -- Determine file to download
    local sFile = tArgs[2]
    local sPath = shell.resolve( sFile )
    if fs.exists( sPath ) then
        print( "File already exists" )
        return
    end
    
    -- GET the contents from pastebin
    local sUser, sRepo, sBranch, sFile;
    sUser = tArgs[3]
    sRepo = tArgs[4]
    sFile = tArgs[5]
    if #tArgs < 6 then
        sBranch = "master"
    else
        sBranch = tArgs[6]
    end
    local res = get(sUser, sRepo, sBranch, sFile)
    if res then        
        local file = fs.open( sPath, "w" )
        file.write( res )
        file.close()
        
        print( "Downloaded as "..tArgs[2] )
    end 
else
    printUsage()
    return
end